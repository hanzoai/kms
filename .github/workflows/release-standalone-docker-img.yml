name: Release standalone docker image
on:
    push:
        tags:
            - "v*.*.*"
            - "v*.*.*-nightly-*"
            - "v*.*.*-nightly-*.*"

jobs:
    kms-tests:
        name: Run tests before deployment
        # https://docs.github.com/en/actions/using-workflows/reusing-workflows#overview
        uses: ./.github/workflows/run-backend-tests.yml

    kms-standalone:
        name: Build kms standalone image postgres
        runs-on: ubuntu-latest
        needs: [kms-tests]
        permissions:
            contents: read
            packages: write
            id-token: write
        steps:
            - name: Extract version from tag
              id: extract_version
              run: echo "::set-output name=version::${GITHUB_REF_NAME}"
            - name: â˜ï¸ Checkout source
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - name: ðŸ“¦ Install dependencies to test all dependencies
              run: npm ci --only-production
              working-directory: backend
            - name: version output
              run: |
                  echo "Output Value: ${{ steps.version.outputs.major }}"
                  echo "Output Value: ${{ steps.version.outputs.minor }}"
                  echo "Output Value: ${{ steps.version.outputs.patch }}"
                  echo "Output Value: ${{ steps.version.outputs.version }}"
                  echo "Output Value: ${{ steps.version.outputs.version_type }}"
                  echo "Output Value: ${{ steps.version.outputs.increment }}"
            - name: Save commit hashes for tag
              id: commit
              uses: pr-mpt/actions-commit-hash@v2
            - name: ðŸ”§ Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
            - name: ðŸ‹ Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: ðŸ“¦ Build backend and export to Docker
              uses: docker/build-push-action@v5
              with:
                  push: true
                  context: .
                  tags: |
                      ghcr.io/hanzoai/kms:latest
                      ghcr.io/hanzoai/kms:${{ steps.commit.outputs.short }}
                      ghcr.io/hanzoai/kms:${{ steps.extract_version.outputs.version }}
                  platforms: linux/amd64,linux/arm64
                  file: Dockerfile.standalone-kms
                  build-args: |
                      POSTHOG_API_KEY=${{ secrets.PUBLIC_POSTHOG_API_KEY }}
                      KMS_PLATFORM_VERSION=${{ steps.extract_version.outputs.version }}
                      DD_GIT_REPOSITORY_URL=${{ github.server_url }}/${{ github.repository }}
                      DD_GIT_COMMIT_SHA=${{ github.sha }}
            - name: Snyk to check Docker image for vulnerabilities
              continue-on-error: true 
              uses: snyk/actions/docker@master
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                image: ghcr.io/hanzoai/kms:${{ steps.extract_version.outputs.version }}
                command: monitor
                args: --file=Dockerfile.standalone-kms --project-name="kms-core-docker-image"

    kms-fips-standalone:
        name: Build kms standalone image postgres
        runs-on: ubuntu-latest
        needs: [kms-tests]
        permissions:
            contents: read
            packages: write
            id-token: write
        steps:
            - name: Extract version from tag
              id: extract_version
              run: echo "::set-output name=version::${GITHUB_REF_NAME}"
            - name: â˜ï¸ Checkout source
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - name: ðŸ“¦ Install dependencies to test all dependencies
              run: npm ci --only-production
              working-directory: backend
            - name: version output
              run: |
                  echo "Output Value: ${{ steps.version.outputs.major }}"
                  echo "Output Value: ${{ steps.version.outputs.minor }}"
                  echo "Output Value: ${{ steps.version.outputs.patch }}"
                  echo "Output Value: ${{ steps.version.outputs.version }}"
                  echo "Output Value: ${{ steps.version.outputs.version_type }}"
                  echo "Output Value: ${{ steps.version.outputs.increment }}"
            - name: Save commit hashes for tag
              id: commit
              uses: pr-mpt/actions-commit-hash@v2
            - name: ðŸ”§ Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
            - name: ðŸ‹ Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: ðŸ“¦ Build backend and export to Docker
              uses: docker/build-push-action@v5
              with:
                  push: true
                  context: .
                  tags: |
                      ghcr.io/hanzoai/kms-fips:latest
                      ghcr.io/hanzoai/kms-fips:${{ steps.commit.outputs.short }}
                      ghcr.io/hanzoai/kms-fips:${{ steps.extract_version.outputs.version }}
                  platforms: linux/amd64,linux/arm64
                  file: Dockerfile.fips.standalone-kms
                  build-args: |
                      POSTHOG_API_KEY=${{ secrets.PUBLIC_POSTHOG_API_KEY }}
                      KMS_PLATFORM_VERSION=${{ steps.extract_version.outputs.version }}
    trigger-binary-release:
      runs-on: ubuntu-latest
      needs: [kms-standalone, kms-fips-standalone]
      steps:
        - name: Create tag if it doesn't exist
          run: |
            TAG_NAME="${{ github.ref_name }}"
            echo "Checking for tag: $TAG_NAME"

            EXACT_MATCH=$(gh api repos/hanzoai/kms-omnibus/git/refs/tags/$TAG_NAME 2>/dev/null | jq -r 'if type == "array" then .[].ref else .ref end' | grep -x "refs/tags/$TAG_NAME" || true)

            if [ "$EXACT_MATCH" == "refs/tags/$TAG_NAME" ]; then
              echo "Tag $TAG_NAME already exists, skipping..."
            else
              echo "Creating tag in hanzoai/kms-omnibus: $TAG_NAME"
              LATEST_SHA=$(gh api repos/hanzoai/kms-omnibus/git/refs/heads/main --jq '.object.sha')
              echo "Latest SHA: $LATEST_SHA"
              
              gh api repos/hanzoai/kms-omnibus/git/refs \
                --method POST \
                --field ref="refs/tags/$TAG_NAME" \
                --field sha="$LATEST_SHA"
              
              echo "Successfully created tag $TAG_NAME"
            fi
          env:
            GH_TOKEN: ${{ secrets.OMNIBUS_RELEASE_TOKEN }}
